#!/bin/bash

# Systemd generator for mount user directory from waydroid
# See systemd.generator(5).

# Try to use builtins as much as possible. Generators run early in bootup process,
# so better not slow down the boot.

USERS=($(getent passwd|awk -F ":" '/home/ && /bash/ {print $1}'));
cat <<EOF > "/tmp/mount.template"
# Automatically generated by waydroid-mounts-generator

[Unit]
Description=Mount unit for Waydroid @DN@ folder

[Mount]
Where=/home/@USER@/@DN@/android
What=/home/@USER@/.local/share/waydroid/data/media/0/@ADN@
Options=bind
EOF

WANTDIR="$1/waydroid-container.service.wants"
mkdir "$WANTDIR"

for USER in "${USERS[@]}"
do
    sed s/@DN@/Documents/g /tmp/mount.template > "$1/home-$USER-Documents-android.mount"
    sed -i s/@ADN@/Documents/g "$1/home-$USER-Documents-android.mount"
    sed -i s/@USER@/$USER/g "$1/home-$USER-Documents-android.mount"
    ln -s "$1/home-$USER-Documents-android.mount" $WANTDIR
    sed s/@DN@/Downloads/g /tmp/mount.template > "$1/home-$USER-Downloads-android.mount"
    sed -i s/@ADN@/Download/g "$1/home-$USER-Downloads-android.mount"
    sed -i s/@USER@/$USER/g "$1/home-$USER-Downloads-android.mount"
    ln -s "$1/home-$USER-Downloads-android.mount" $WANTDIR
    sed s/@DN@/Music/g /tmp/mount.template > "$1/home-$USER-Music-android.mount"
    sed -i s/@ADN@/Music/g "$1/home-$USER-Music-android.mount"
    sed -i s/@USER@/$USER/g "$1/home-$USER-Music-android.mount"
    ln -s "$1/home-$USER-Music-android.mount" $WANTDIR
    sed s/@DN@/Pictures/g /tmp/mount.template > "$1/home-$USER-Pictures-android.mount"
    sed -i s/@ADN@/Pictures/g "$1/home-$USER-Pictures-android.mount"
    sed -i s/@USER@/$USER/g "$1/home-$USER-Pictures-android.mount"
    ln -s "$1/home-$USER-Pictures-android.mount" $WANTDIR
    sed s/@DN@/Videos/g /tmp/mount.template > "$1/home-$USER-Videos-android.mount"
    sed -i s/@ADN@/Movies/g "$1/home-$USER-Videos-android.mount"
    sed -i s/@USER@/$USER/g "$1/home-$USER-Videos-android.mount"
    ln -s "$1/home-$USER-Videos-android.mount" $WANTDIR
done;

rm /tmp/mount.template
